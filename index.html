<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FPS Game</title>
  <script defer src="https://cdn.babylonjs.com/babylon.js"></script>
  <script defer src="https://cdn.babylonjs.com/loaders/babylonjs.loaders.min.js"></script>
  <script defer src="https://cdn.babylonjs.com/cannon.js"></script>
</head>
<body>
  <canvas id="renderCanvas" style="width: 100%; height: 100%;"></canvas>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      var canvas = document.getElementById('renderCanvas');
      var engine = new BABYLON.Engine(canvas, true);
      var camera;
      var canJump = true;

      var createScene = function () {
        var scene = new BABYLON.Scene(engine);
        scene.enablePhysics(new BABYLON.Vector3(0, -9.81, 0), new BABYLON.CannonJSPlugin());

        // Luo maan pinta
        var ground = BABYLON.MeshBuilder.CreateGround('ground', { width: 100, height: 100 }, scene);
        ground.material = new BABYLON.StandardMaterial('groundMaterial', scene);
        ground.material.diffuseColor = new BABYLON.Color3(0.8, 0.7, 0.5);
        ground.physicsImpostor = new BABYLON.PhysicsImpostor(ground, BABYLON.PhysicsImpostor.BoxImpostor, { mass: 0, restitution: 0.9 }, scene);

        // Luo pelaajan kamera
        camera = new BABYLON.FreeCamera('camera', new BABYLON.Vector3(0, 1, -10), scene);
        camera.setTarget(new BABYLON.Vector3(0, 1, 0));
        camera.attachControl(canvas, true);
        camera.ellipsoid = new BABYLON.Vector3(1, 1, 1);
        camera.checkCollisions = true;
        camera.applyGravity = true; // Lisätty painovoima

        // Luo puut maan pinnalle
        createTrees(scene);

        return scene;
      };

      var createTrees = function (scene) {
        for (var i = 0; i < 100; i++) {
          var tree = BABYLON.MeshBuilder.CreateCylinder('tree', { height: 3, diameterTop: 0.5, diameterBottom: 2 }, scene);
          tree.position = new BABYLON.Vector3(Math.random() * 90 - 45, 1.5, Math.random() * 90 - 45);
          tree.material = new BABYLON.StandardMaterial('treeMaterial', scene);
          tree.material.diffuseColor = new BABYLON.Color3(0.3, 0.8, 0.4);
          tree.material.specularColor = new BABYLON.Color3(0, 0, 0);
          tree.material.emissiveColor = new BABYLON.Color3(0.2, 0.2, 0.2);
          tree.physicsImpostor = new BABYLON.PhysicsImpostor(tree, BABYLON.PhysicsImpostor.CylinderImpostor, { mass: 0, restitution: 0, ignoreParent: true }, scene);
        }
      };

      var scene = createScene();

      // Käynnistä renderöinti
      engine.runRenderLoop(function () {
        scene.render();
      });

      // Päivitä näppäinasetukset
      scene.inputStates = { up: false, down: false, left: false, right: false };

      window.addEventListener('keydown', function (event) {
        switch (event.key) {
          case 'w':
            scene.inputStates.up = true;
            break;
          case 's':
            scene.inputStates.down = true;
            break;
          case 'a':
            scene.inputStates.left = true;
            break;
          case 'd':
            scene.inputStates.right = true;
            break;
          case ' ':
            if (canJump) {
              camera.applyImpulse(new BABYLON.Vector3(0, 5, 0), camera.position);
              canJump = false;
            }
            break;
        }
      });

      window.addEventListener('keyup', function (event) {
        switch (event.key) {
          case 'w':
            scene.inputStates.up = false;
            break;
          case 's':
            scene.inputStates.down = false;
            break;
          case 'a':
            scene.inputStates.left = false;
            break;
          case 'd':
            scene.inputStates.right = false;
            break;
        }
      });

      // Liikkumisen päivitys
      scene.onBeforeRenderObservable.add(function () {
        var playerSpeed = 0.1;
        var playerDirection = new BABYLON.Vector3(0, 0, 0);

        if (scene.inputStates.up) {
          playerDirection.z = 1;
        }
        if (scene.inputStates.down) {
          playerDirection.z = -1;
        }
        if (scene.inputStates.left) {
          playerDirection.x = -1;
        }
        if (scene.inputStates.right) {
          playerDirection.x = 1;
        }

        playerDirection.normalize();

        var delta = playerDirection.scale(playerSpeed);
        var forward = camera.getFrontPosition(1).subtract(camera.position).normalize();
        delta = new BABYLON.Vector3(forward.x * delta.z, delta.y, forward.z * delta.z);

        camera.position.addInPlace(delta);

        if (camera.position.y < 1.01) {
          canJump = true;
        }
      });

      window.addEventListener('resize', function () {
        engine.resize();
      });
    });
  </script>
</body>
</html>
